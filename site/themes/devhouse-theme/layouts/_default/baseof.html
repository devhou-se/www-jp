<!DOCTYPE html>
<html>
{{- partial "head.html" . -}}
<body>
<div class="コンテナ">
    <div class="ヘッダ 章">
        {{- partial "header.html" . -}}
    </div>
    <div class="主要">
        <div class="左-ナビ 章">
            {{- partial "sidebar.html" . }}
        </div>
        <div class="内容 章">
            {{- block "main" . }}{{- end }}
        </div>
        <div class="右-ナビ 章">
            {{- partial "infobar.html" . }}
        </div>
    </div>
</div>
{{ partial "footer.html" . }}
<script>
    // Theme functionality
    function applyTheme(theme) {
        const darkStylesheet = document.getElementById('theme-dark');
        const lightStylesheet = document.getElementById('theme-light');
        if (darkStylesheet && lightStylesheet) {
            darkStylesheet.disabled = (theme !== 'dark');
            lightStylesheet.disabled = (theme === 'dark');
        }
        updateLogo(theme);
    }

    function updateLogo(theme) {
        // Process any queued logo updates from head.html
        if (window.updateLogoQueue && window.updateLogoQueue.length > 0) {
            while (window.updateLogoQueue.length > 0) {
                const queuedTheme = window.updateLogoQueue.shift();
                updateLogo(queuedTheme);
            }
        }
        const logo = document.getElementById('site-logo');
        if (logo) {
            logo.src = theme === 'light' ? '/images/logo-dark.svg' : '/images/logo-white.svg';
        }
    }

    function getPreferredTheme() {
        let theme = localStorage.getItem('theme');
        if (!theme) {
            theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }
        return theme;
    }

    function toggleTheme() {
        const currentTheme = getPreferredTheme();
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        localStorage.setItem('theme', newTheme);
        applyTheme(newTheme);
    }


    // Mobile collapsible sidebar and theme initialization
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize theme and logo immediately
        const theme = getPreferredTheme();
        applyTheme(theme);

        // Theme toggle button
        const themeToggle = document.getElementById('theme-toggle');
        if (themeToggle) {
            themeToggle.addEventListener('click', function(e) {
                e.preventDefault();
                toggleTheme();
            });
        }

        // Mobile sidebar behavior
        if (window.innerWidth <= 1400) {
            const sidebar = document.querySelector('div.左-ナビ');
            if (sidebar) {
                // Start collapsed on mobile
                sidebar.classList.add('collapsed');

                const heading = sidebar.querySelector('p');
                if (heading) {
                    let touchMoved = false;
                    let isScrolling = false;

                    heading.addEventListener('touchstart', function() {
                        touchMoved = false;
                        isScrolling = false;
                    }, { passive: true });

                    heading.addEventListener('touchmove', function() {
                        touchMoved = true;
                    }, { passive: true });

                    // Detect page scrolling during touch interaction
                    window.addEventListener('scroll', function() {
                        isScrolling = true;
                    }, { passive: true });

                    // Add both click and touchend handlers for better mobile support
                    const toggleSidebar = function(e) {
                        // Ignore if it was from a scroll gesture
                        if (touchMoved || isScrolling) {
                            return;
                        }
                        e.preventDefault();
                        sidebar.classList.toggle('collapsed');
                    };

                    heading.addEventListener('click', toggleSidebar);
                    heading.addEventListener('touchend', function(e) {
                        if (!touchMoved && !isScrolling) {
                            e.preventDefault();
                            sidebar.classList.toggle('collapsed');
                        }
                    }, { passive: false });
                }
            }
        }

        // Re-check on window resize
        window.addEventListener('resize', function() {
            const sidebar = document.querySelector('div.左-ナビ');
            if (sidebar) {
                if (window.innerWidth <= 1400) {
                    if (!sidebar.classList.contains('collapsed')) {
                        sidebar.classList.add('collapsed');
                    }
                } else {
                    sidebar.classList.remove('collapsed');
                }
            }
        });
    });
</script>
</body>
</html>