{{ define "main" }}
{{- $galleryContent := readFile "content/gallery.md" -}}
<style>
:root {
    --gallery-thumb-min-width: {{ .Site.Params.galleryThumbnailMinWidth | default "130px" }};
    --gallery-thumb-min-width-mobile: {{ .Site.Params.galleryThumbnailMinWidthMobile | default "120px" }};
}
</style>
<div class="gallery-container">
    <div class="gallery-grid" id="galleryGrid"></div>
    <textarea id="galleryData" style="display:none;">{{ $galleryContent }}</textarea>
</div>

<!-- Lightbox -->
<div class="lightbox" id="lightbox">
    <span class="lightbox-close" id="lightboxClose">&times;</span>
    <span class="lightbox-nav lightbox-prev" id="lightboxPrev">‹</span>
    <div class="lightbox-content">
        <img class="lightbox-image" id="lightboxImage" src="" alt="">
    </div>
    <span class="lightbox-nav lightbox-next" id="lightboxNext">›</span>
    <a class="lightbox-link" id="lightboxLink" href="#" style="display: none;">ブログ投稿を見る →</a>
    <div class="lightbox-counter" id="lightboxCounter"></div>
</div>

<script>
// Gallery items data - parse from content
(function() {
    const rawContent = document.getElementById('galleryData').value;
    const items = [];

    // Regex to match [![...](github-url)](post-url)
    // Handles both formats:
    // - https://github.com/owner/repo/assets/userid/image-id
    // - https://github.com/user-attachments/assets/image-id
    const regex = /\[!\[[^\]]*\]\(https:\/\/github\.com\/.*?\/assets\/(?:[^\/]+\/)?([a-f0-9-]+)\)\]\(([^)]+)\)/g;
    let match;

    while ((match = regex.exec(rawContent)) !== null) {
        items.push({
            thumbnailUrl: `https://storage.googleapis.com/static.devh.se/images/${match[1]}_0.jpeg`,
            thumbnailFallback: `https://github.com/devhou-se/www-jp/assets/5674656/${match[1]}`,
            fullUrl: `https://storage.googleapis.com/static.devh.se/images/${match[1]}.jpeg`,
            fullFallback: `https://storage.googleapis.com/static.devh.se/images/${match[1]}_2.jpeg`,
            postUrl: match[2]
        });
    }

    const galleryGrid = document.getElementById('galleryGrid');
    const lightbox = document.getElementById('lightbox');
    const lightboxImage = document.getElementById('lightboxImage');
    const lightboxClose = document.getElementById('lightboxClose');
    const lightboxPrev = document.getElementById('lightboxPrev');
    const lightboxNext = document.getElementById('lightboxNext');
    const lightboxCounter = document.getElementById('lightboxCounter');
    const lightboxLink = document.getElementById('lightboxLink');

    let currentIndex = 0;

    // Create thumbnail grid with Intersection Observer for progressive loading
    const observerOptions = {
        root: null,
        rootMargin: '50px',
        threshold: 0.01
    };

    const imageObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                const itemData = items[parseInt(img.dataset.index)];

                // Progressive loading: _0 -> _1 -> _2
                const loadNextSrc = (src, nextCallback) => {
                    const testImg = new Image();
                    testImg.onload = () => {
                        img.src = src;
                        if (nextCallback) nextCallback();
                    };
                    testImg.onerror = () => {
                        // If optimized image fails, try fallback
                        if (nextCallback) nextCallback();
                        else img.src = itemData.thumbnailFallback;
                    };
                    testImg.src = src;
                };

                const imageId = itemData.thumbnailUrl.split('/').pop().replace('_0.jpeg', '');
                loadNextSrc(`https://storage.googleapis.com/static.devh.se/images/${imageId}_0.jpeg`, () =>
                    loadNextSrc(`https://storage.googleapis.com/static.devh.se/images/${imageId}_1.jpeg`, () =>
                        loadNextSrc(`https://storage.googleapis.com/static.devh.se/images/${imageId}_2.jpeg`)
                    )
                );

                imageObserver.unobserve(img);
            }
        });
    }, observerOptions);

    items.forEach((item, index) => {
        const gridItem = document.createElement('div');
        gridItem.className = 'gallery-item';
        gridItem.onclick = () => openLightbox(index);

        const img = document.createElement('img');
        img.alt = 'Gallery image ' + (index + 1);
        img.dataset.index = index;

        // Set a placeholder or minimal initial src
        img.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"%3E%3Crect fill="%23ddd" width="240" height="240"/%3E%3C/svg%3E';

        gridItem.appendChild(img);
        galleryGrid.appendChild(gridItem);

        // Observe the image for lazy loading
        imageObserver.observe(img);
    });

    function openLightbox(index) {
        currentIndex = index;
        updateLightbox();
        lightbox.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
        lightbox.classList.remove('active');
        document.body.style.overflow = '';
    }

    function updateLightbox() {
        const item = items[currentIndex];

        // Use GitHub thumbnail first, then try to lazy load optimized full image
        lightboxImage.src = item.thumbnailFallback;

        const fullImage = new Image();
        fullImage.onload = () => {
            lightboxImage.src = fullImage.src;
        };
        fullImage.onerror = () => {
            // If optimized image fails, use medium size fallback
            const fallback = new Image();
            fallback.onload = () => {
                lightboxImage.src = item.fullFallback;
            };
            fallback.onerror = () => {
                // Keep GitHub URL if all else fails
            };
            fallback.src = item.fullFallback;
        };
        fullImage.src = item.fullUrl;

        lightboxCounter.textContent = `${currentIndex + 1} / ${items.length}`;

        // Update post link
        if (item.postUrl) {
            lightboxLink.href = item.postUrl;
            lightboxLink.style.display = 'block';
        } else {
            lightboxLink.style.display = 'none';
        }
    }

    function showNext() {
        currentIndex = (currentIndex + 1) % items.length;
        updateLightbox();
    }

    function showPrev() {
        currentIndex = (currentIndex - 1 + items.length) % items.length;
        updateLightbox();
    }

    // Event listeners
    lightboxClose.onclick = closeLightbox;
    lightboxNext.onclick = showNext;
    lightboxPrev.onclick = showPrev;

    // Close on background click
    lightbox.onclick = (e) => {
        if (e.target === lightbox) {
            closeLightbox();
        }
    };

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
        if (!lightbox.classList.contains('active')) return;

        switch(e.key) {
            case 'Escape':
                closeLightbox();
                break;
            case 'ArrowLeft':
                showPrev();
                break;
            case 'ArrowRight':
                showNext();
                break;
        }
    });
})();
</script>

{{- partial "reactions.html" . -}}
{{ end }}
